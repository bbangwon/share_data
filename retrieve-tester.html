<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Qdrant /retrieve API Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      body {
        margin: 0;
        padding: 0;
        background: #0d1117;
        color: #e6edf3;
      }
      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 32px 16px 64px;
      }
      h1 {
        margin-bottom: 0.5rem;
        font-size: 1.8rem;
      }
      p.lead {
        color: #9da4b1;
        margin-top: 0;
        margin-bottom: 1.5rem;
      }
      form {
        display: grid;
        gap: 16px;
        background: #161b22;
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #30363d;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.92rem;
      }
      input,
      select,
      textarea {
        background: #0d1117;
        color: #e6edf3;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 0.95rem;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: 2px solid #4e9bff;
        border-color: #4e9bff;
      }
      textarea {
        min-height: 72px;
      }
      .inline {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .inline label {
        flex: 1;
        min-width: 220px;
      }
      .section-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }
      .group {
        border: 1px solid #30363d;
        border-radius: 10px;
        padding: 16px;
        display: grid;
        gap: 12px;
      }
      .chip-button {
        background: #238636;
        border: none;
        color: #fff;
        padding: 10px 16px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.15s ease;
      }
      .chip-button.secondary {
        background: #30363d;
      }
      .chip-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .chip-button:hover:not(:disabled) {
        opacity: 0.9;
      }
      .danger {
        background: #da3633;
      }
      .list-stack {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .stack-row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .stack-row input,
      .stack-row textarea,
      .stack-row select {
        flex: 1;
      }
      pre {
        background: #0d1117;
        border-radius: 10px;
        padding: 16px;
        border: 1px solid #30363d;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      #status {
        min-height: 1.2em;
        font-size: 0.9rem;
        color: #9da4b1;
      }
      @media (max-width: 640px) {
        form {
          padding: 16px;
        }
        .stack-row {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>/retrieve 라우터 테스트</h1>
      <p class="lead">
        Qdrant 검색 API에 보낼 JSON 페이로드를 손쉽게 조정해 보고, 응답을 확인하세요.
      </p>
      <form id="retrieveForm">
        <label>
          API URL
          <input
            name="endpoint"
            type="url"
            value="http://localhost:8000/api/v1/qdrant/retrieve"
            required
          />
        </label>

        <div class="group">
          <p class="section-title">기본 설정</p>
          <div class="inline">
            <label>
              Collection Name
              <input name="collection_name" placeholder="default: settings.COLLECTION_NAME" />
            </label>
            <label>
              Retrieve Type
              <select name="retrieve_type">
                <option value="">(서버 기본값)</option>
                <option value="semantic">semantic</option>
                <option value="lexical">lexical</option>
                <option value="hybrid" selected>hybrid</option>
              </select>
            </label>
          </div>
          <div class="inline">
            <label>
              Dense Limit
              <input name="dense_limit" type="number" min="1" max="500" placeholder="ex) 20" />
            </label>
            <label>
              Sparse Limit
              <input name="sparse_limit" type="number" min="1" max="500" placeholder="ex) 20" />
            </label>
            <label>
              Final Limit
              <input name="final_limit" type="number" min="1" max="50" placeholder="ex) 10" />
            </label>
          </div>
        </div>

        <div class="group">
          <p class="section-title">Dense Embedding</p>
          <div class="inline">
            <label>
              Type
              <select name="dense_type">
                <option value="">(default)</option>
                <option value="bge">bge</option>
                <option value="jina">jina</option>
              </select>
            </label>
            <label>
              Name
              <input name="dense_name" placeholder="예: bge-m3" />
            </label>
          </div>
        </div>

        <div class="group">
          <p class="section-title">Sparse Embedding</p>
          <div class="inline">
            <label>
              Type
              <select name="sparse_type">
                <option value="">(default)</option>
                <option value="bm25">bm25</option>
              </select>
            </label>
            <label>
              Name
              <input name="sparse_name" placeholder="예: bm25" />
            </label>
          </div>
        </div>

        <div class="group">
          <p class="section-title">Reranking</p>
          <div class="inline">
            <label class="inline-choice">
              <input type="checkbox" name="rerank_active" />
              is_active
            </label>
            <label>
              target
              <select name="rerank_target">
                <option value="">(default)</option>
                <option value="text">text</option>
                <option value="parent_text">parent_text</option>
              </select>
            </label>
            <label class="inline-choice">
              <input type="checkbox" name="rerank_summary" />
              include_summary
            </label>
          </div>
        </div>

        <div class="group">
          <div class="section-title">질의 목록</div>
          <div id="queriesContainer" class="list-stack"></div>
          <button type="button" class="chip-button secondary" id="addQueryButton">
            + 질의 추가
          </button>
        </div>

        <div class="group">
          <div class="section-title">필터 (선택)</div>
          <div id="filtersContainer" class="list-stack"></div>
          <button type="button" class="chip-button secondary" id="addFilterButton">
            + 필터 추가
          </button>
        </div>

        <button type="submit" class="chip-button">/retrieve 호출</button>
        <div id="status"></div>
      </form>

      <section style="margin-top: 32px; display: grid; gap: 16px">
        <div>
          <h2 class="section-title">Request Preview</h2>
          <pre id="requestPreview">{}</pre>
        </div>
        <div>
          <h2 class="section-title">Response</h2>
          <pre id="responseOutput">결과가 여기에 표시됩니다.</pre>
        </div>
      </section>
    </main>

    <script>
      const queriesContainer = document.getElementById("queriesContainer");
      const filtersContainer = document.getElementById("filtersContainer");
      const addQueryButton = document.getElementById("addQueryButton");
      const addFilterButton = document.getElementById("addFilterButton");
      const form = document.getElementById("retrieveForm");
      const statusEl = document.getElementById("status");
      const requestPreview = document.getElementById("requestPreview");
      const responseOutput = document.getElementById("responseOutput");

      function addQueryField(value = "") {
        const row = document.createElement("div");
        row.className = "stack-row";

        const textarea = document.createElement("textarea");
        textarea.placeholder = "예) 부산시 행정 조직도를 설명해줘";
        textarea.value = value;

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "삭제";
        removeBtn.className = "chip-button danger";
        removeBtn.addEventListener("click", () => {
          queriesContainer.removeChild(row);
          if (!queriesContainer.children.length) {
            addQueryField();
          }
        });

        row.append(textarea, removeBtn);
        queriesContainer.appendChild(row);
      }

      function addFilterRow(initial = {}) {
        const row = document.createElement("div");
        row.className = "stack-row";

        const keyInput = document.createElement("input");
        keyInput.placeholder = "key (예: group)";
        keyInput.value = initial.key ?? "";

        const valuesInput = document.createElement("input");
        valuesInput.placeholder = "values (쉼표 구분)";
        valuesInput.value = initial.values?.join(", ") ?? "";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "삭제";
        removeBtn.className = "chip-button danger";
        removeBtn.addEventListener("click", () => filtersContainer.removeChild(row));

        row.append(keyInput, valuesInput, removeBtn);
        filtersContainer.appendChild(row);
      }

      addQueryButton.addEventListener("click", () => addQueryField());
      addFilterButton.addEventListener("click", () => addFilterRow());
      addQueryField();

      function parseNumber(value) {
        if (value === "" || value === null || value === undefined) return undefined;
        const num = Number(value);
        return Number.isFinite(num) ? num : undefined;
      }

      function buildPayload(formData) {
        const payload = {
          queries: Array.from(queriesContainer.querySelectorAll("textarea"))
            .map((el) => el.value.trim())
            .filter(Boolean),
        };

        if (!payload.queries.length) {
          throw new Error("최소 1개의 질의를 입력하세요.");
        }

        const collectionName = formData.get("collection_name")?.trim();
        if (collectionName) payload.collection_name = collectionName;

        const retrieveType = formData.get("retrieve_type");
        if (retrieveType) payload.retrieve_type = retrieveType;

        const denseLimit = parseNumber(formData.get("dense_limit"));
        if (denseLimit !== undefined) payload.dense_limit = denseLimit;

        const sparseLimit = parseNumber(formData.get("sparse_limit"));
        if (sparseLimit !== undefined) payload.sparse_limit = sparseLimit;

        const finalLimit = parseNumber(formData.get("final_limit"));
        if (finalLimit !== undefined) payload.final_limit = finalLimit;

        const denseType = formData.get("dense_type");
        const denseName = formData.get("dense_name")?.trim();
        if (denseType || denseName) {
          payload.dense_embedding = {
            type: denseType || null,
            name: denseName || null,
          };
        }

        const sparseType = formData.get("sparse_type");
        const sparseName = formData.get("sparse_name")?.trim();
        if (sparseType || sparseName) {
          payload.sparse_embedding = {
            type: sparseType || null,
            name: sparseName || null,
          };
        }

        const rerankActive = formData.get("rerank_active") === "on";
        const rerankTarget = formData.get("rerank_target");
        const rerankSummary = formData.get("rerank_summary") === "on";
        if (rerankActive || rerankTarget || rerankSummary) {
          payload.reranking = {
            is_active: rerankActive,
            target: rerankTarget || null,
            include_summary: rerankSummary,
          };
        }

        const filters = Array.from(filtersContainer.children)
          .map((row) => {
            const [keyInput, valuesInput] = row.querySelectorAll("input");
            const key = keyInput.value.trim();
            const values = valuesInput.value
              .split(",")
              .map((value) => value.trim())
              .filter(Boolean);
            if (!key || !values.length) return null;
            return { key, values };
          })
          .filter(Boolean);

        if (filters.length) payload.filters = filters;

        return payload;
      }

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? "#f78c6c" : "#9da4b1";
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        let payload;

        try {
          payload = buildPayload(formData);
        } catch (err) {
          setStatus(err.message, true);
          return;
        }

        requestPreview.textContent = JSON.stringify(payload, null, 2);
        const endpoint = formData.get("endpoint");
        setStatus("요청 중...");

        try {
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const text = await response.text();
          let parsed;
          try {
            parsed = JSON.parse(text);
            responseOutput.textContent = JSON.stringify(parsed, null, 2);
          } catch {
            responseOutput.textContent = text || "(빈 응답)";
          }

          if (!response.ok) {
            setStatus(`오류: ${response.status} ${response.statusText}`, true);
          } else {
            setStatus("완료");
          }
        } catch (error) {
          setStatus(`요청 실패: ${error.message}`, true);
          responseOutput.textContent = "네트워크 에러가 발생했습니다.";
        }
      });
    </script>
  </body>
</html>
