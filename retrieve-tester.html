<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Qdrant /retrieve API Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      body {
        margin: 0;
        padding: 0;
        background: #0d1117;
        color: #e6edf3;
      }
      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 32px 16px 64px;
      }
      h1 {
        margin-bottom: 0.5rem;
        font-size: 1.8rem;
      }
      p.lead {
        color: #9da4b1;
        margin-top: 0;
        margin-bottom: 1.5rem;
      }
      form {
        display: grid;
        gap: 16px;
        background: #161b22;
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #30363d;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.92rem;
      }
      input,
      select,
      textarea {
        background: #0d1117;
        color: #e6edf3;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 0.95rem;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: 2px solid #4e9bff;
        border-color: #4e9bff;
      }
      textarea {
        min-height: 72px;
      }
      .inline {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .inline label {
        flex: 1;
        min-width: 220px;
      }
      .section-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }
      .group {
        border: 1px solid #30363d;
        border-radius: 10px;
        padding: 16px;
        display: grid;
        gap: 12px;
      }
      .chip-button {
        background: #238636;
        border: none;
        color: #fff;
        padding: 10px 16px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.15s ease;
      }
      .chip-button.secondary {
        background: #30363d;
      }
      .chip-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .chip-button:hover:not(:disabled) {
        opacity: 0.9;
      }
      .danger {
        background: #da3633;
      }
      .list-stack {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .stack-row {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .stack-row input,
      .stack-row textarea,
      .stack-row select {
        flex: 1;
      }
      pre {
        background: #0d1117;
        border-radius: 10px;
        padding: 16px;
        border: 1px solid #30363d;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      .muted {
        color: #9da4b1;
        font-size: 0.9rem;
      }
      .results-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 12px;
      }
      .result-group {
        border: 1px solid #30363d;
        border-radius: 12px;
        padding: 16px;
        background: #11151c;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .result-group__header {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .result-group__header .query-label {
        font-size: 0.78rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #6e7681;
      }
      .result-group__header .query-text {
        font-size: 1.05rem;
        font-weight: 600;
      }
      .doc-card {
        border: 1px solid #232933;
        border-radius: 10px;
        padding: 14px;
        background: #0d1117;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .doc-card__header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: center;
      }
      .doc-card__title {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        background: #30363d;
        color: #e6edf3;
        border-radius: 999px;
        padding: 2px 10px;
      }
      .doc-card__id {
        font-weight: 600;
        word-break: break-all;
      }
      .doc-card__score {
        font-size: 0.9rem;
        color: #8dd16a;
        font-weight: 600;
        white-space: nowrap;
      }
      .meta-list {
        display: grid;
        grid-template-columns: minmax(120px, 160px) 1fr;
        gap: 6px 12px;
        margin: 0;
      }
      .meta-list dt {
        color: #9da4b1;
        font-size: 0.83rem;
      }
      .meta-list dd {
        margin: 0;
        font-size: 0.9rem;
        word-break: break-word;
      }
      .service-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .chip {
        border-radius: 999px;
        border: 1px solid #30363d;
        padding: 2px 10px;
        font-size: 0.78rem;
      }
      .text-panel {
        border: 1px solid #1f242d;
        border-radius: 10px;
        padding: 12px;
        background: #050608;
      }
      .text-panel + .text-panel {
        margin-top: 10px;
      }
      .text-panel__header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 8px;
      }
      .text-panel__header h4 {
        margin: 0;
        font-size: 1rem;
      }
      .text-panel__controls {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .pill-button {
        border: 1px solid #30363d;
        background: transparent;
        color: #e6edf3;
        border-radius: 999px;
        padding: 4px 12px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
      }
      .pill-button.small {
        font-size: 0.75rem;
        padding: 4px 10px;
      }
      .pill-button.secondary {
        background: #30363d;
      }
      .pill-button.active {
        background: #4e9bff;
        border-color: #4e9bff;
        color: #050608;
      }
      .pill-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .text-panel__body {
        border: 1px solid #1f242d;
        border-radius: 8px;
        min-height: 80px;
        background: #0d1117;
      }
      .text-panel__content {
        margin: 0;
        padding: 10px;
        font-size: 0.92rem;
        max-height: 320px;
        overflow-y: auto;
      }
      .text-panel__content pre {
        background: none;
        border: none;
        padding: 0;
        margin: 0;
      }
      .text-panel__content.is-hidden {
        display: none;
      }
      a.file-link {
        color: #4e9bff;
        text-decoration: none;
        word-break: break-all;
      }
      a.file-link:hover {
        text-decoration: underline;
      }
      #status {
        min-height: 1.2em;
        font-size: 0.9rem;
        color: #9da4b1;
      }
      @media (max-width: 640px) {
        form {
          padding: 16px;
        }
        .stack-row {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>/retrieve 라우터 테스트</h1>
      <p class="lead">
        Qdrant 검색 API에 보낼 JSON 페이로드를 손쉽게 조정해 보고, 응답을 확인하세요.
      </p>
      <form id="retrieveForm">
        <label>
          API URL
          <input
            name="endpoint"
            type="url"
            value="http://localhost:8000/api/v1/qdrant/retrieve"
            required
          />
        </label>

        <div class="group">
          <p class="section-title">기본 설정</p>
          <div class="inline">
            <label>
              Collection Name
              <input name="collection_name" placeholder="default: settings.COLLECTION_NAME" />
            </label>
            <label>
              Retrieve Type
              <select name="retrieve_type">
                <option value="">(서버 기본값)</option>
                <option value="semantic">semantic</option>
                <option value="lexical">lexical</option>
                <option value="hybrid" selected>hybrid</option>
              </select>
            </label>
          </div>
          <div class="inline">
            <label>
              Dense Limit
              <input name="dense_limit" type="number" min="1" max="500" placeholder="ex) 20" />
            </label>
            <label>
              Sparse Limit
              <input name="sparse_limit" type="number" min="1" max="500" placeholder="ex) 20" />
            </label>
            <label>
              Final Limit
              <input name="final_limit" type="number" min="1" max="50" placeholder="ex) 10" />
            </label>
          </div>
        </div>

        <div class="group">
          <p class="section-title">Dense Embedding</p>
          <div class="inline">
            <label>
              Type
              <select name="dense_type">
                <option value="">(default)</option>
                <option value="bge">bge</option>
                <option value="jina">jina</option>
              </select>
            </label>
            <label>
              Name
              <input name="dense_name" placeholder="예: bge-m3" />
            </label>
          </div>
        </div>

        <div class="group">
          <p class="section-title">Sparse Embedding</p>
          <div class="inline">
            <label>
              Type
              <select name="sparse_type">
                <option value="">(default)</option>
                <option value="bm25">bm25</option>
              </select>
            </label>
            <label>
              Name
              <input name="sparse_name" placeholder="예: bm25" />
            </label>
          </div>
        </div>

        <div class="group">
          <p class="section-title">Reranking</p>
          <div class="inline">
            <label class="inline-choice">
              <input type="checkbox" name="rerank_active" />
              is_active
            </label>
            <label>
              target
              <select name="rerank_target">
                <option value="">(default)</option>
                <option value="text">text</option>
                <option value="parent_text">parent_text</option>
              </select>
            </label>
            <label class="inline-choice">
              <input type="checkbox" name="rerank_summary" />
              include_summary
            </label>
          </div>
        </div>

        <div class="group">
          <div class="section-title">질의 목록</div>
          <div id="queriesContainer" class="list-stack"></div>
          <button type="button" class="chip-button secondary" id="addQueryButton">
            + 질의 추가
          </button>
        </div>

        <div class="group">
          <div class="section-title">필터 (선택)</div>
          <div id="filtersContainer" class="list-stack"></div>
          <button type="button" class="chip-button secondary" id="addFilterButton">
            + 필터 추가
          </button>
        </div>

        <button type="submit" class="chip-button">/retrieve 호출</button>
        <div id="status"></div>
      </form>

      <section style="margin-top: 32px; display: grid; gap: 16px">
        <div>
          <h2 class="section-title">Request Preview</h2>
          <pre id="requestPreview">{}</pre>
        </div>
        <div>
          <h2 class="section-title">Response</h2>
          <pre id="responseOutput">결과가 여기에 표시됩니다.</pre>
          <div id="responseCards" class="results-grid">
            <p class="muted">API 호출 후 검색 결과 카드가 여기에 표시됩니다.</p>
          </div>
        </div>
      </section>
    </main>

    <script>
      const queriesContainer = document.getElementById("queriesContainer");
      const filtersContainer = document.getElementById("filtersContainer");
      const addQueryButton = document.getElementById("addQueryButton");
      const addFilterButton = document.getElementById("addFilterButton");
      const form = document.getElementById("retrieveForm");
      const statusEl = document.getElementById("status");
      const requestPreview = document.getElementById("requestPreview");
      const responseOutput = document.getElementById("responseOutput");
      const responseCards = document.getElementById("responseCards");

      function addQueryField(value = "") {
        const row = document.createElement("div");
        row.className = "stack-row";

        const textarea = document.createElement("textarea");
        textarea.placeholder = "예) 부산시 행정 조직도를 설명해줘";
        textarea.value = value;

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "삭제";
        removeBtn.className = "chip-button danger";
        removeBtn.addEventListener("click", () => {
          queriesContainer.removeChild(row);
          if (!queriesContainer.children.length) {
            addQueryField();
          }
        });

        row.append(textarea, removeBtn);
        queriesContainer.appendChild(row);
      }

      function addFilterRow(initial = {}) {
        const row = document.createElement("div");
        row.className = "stack-row";

        const keyInput = document.createElement("input");
        keyInput.placeholder = "key (예: group)";
        keyInput.value = initial.key ?? "";

        const valuesInput = document.createElement("input");
        valuesInput.placeholder = "values (쉼표 구분)";
        valuesInput.value = initial.values?.join(", ") ?? "";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "삭제";
        removeBtn.className = "chip-button danger";
        removeBtn.addEventListener("click", () => filtersContainer.removeChild(row));

        row.append(keyInput, valuesInput, removeBtn);
        filtersContainer.appendChild(row);
      }

      addQueryButton.addEventListener("click", () => addQueryField());
      addFilterButton.addEventListener("click", () => addFilterRow());
      addQueryField();

      function parseNumber(value) {
        if (value === "" || value === null || value === undefined) return undefined;
        const num = Number(value);
        return Number.isFinite(num) ? num : undefined;
      }

      function buildPayload(formData) {
        const payload = {
          queries: Array.from(queriesContainer.querySelectorAll("textarea"))
            .map((el) => el.value.trim())
            .filter(Boolean),
        };

        if (!payload.queries.length) {
          throw new Error("최소 1개의 질의를 입력하세요.");
        }

        const collectionName = formData.get("collection_name")?.trim();
        if (collectionName) payload.collection_name = collectionName;

        const retrieveType = formData.get("retrieve_type");
        if (retrieveType) payload.retrieve_type = retrieveType;

        const denseLimit = parseNumber(formData.get("dense_limit"));
        if (denseLimit !== undefined) payload.dense_limit = denseLimit;

        const sparseLimit = parseNumber(formData.get("sparse_limit"));
        if (sparseLimit !== undefined) payload.sparse_limit = sparseLimit;

        const finalLimit = parseNumber(formData.get("final_limit"));
        if (finalLimit !== undefined) payload.final_limit = finalLimit;

        const denseType = formData.get("dense_type");
        const denseName = formData.get("dense_name")?.trim();
        if (denseType || denseName) {
          payload.dense_embedding = {
            type: denseType || null,
            name: denseName || null,
          };
        }

        const sparseType = formData.get("sparse_type");
        const sparseName = formData.get("sparse_name")?.trim();
        if (sparseType || sparseName) {
          payload.sparse_embedding = {
            type: sparseType || null,
            name: sparseName || null,
          };
        }

        const rerankActive = formData.get("rerank_active") === "on";
        const rerankTarget = formData.get("rerank_target");
        const rerankSummary = formData.get("rerank_summary") === "on";
        if (rerankActive || rerankTarget || rerankSummary) {
          payload.reranking = {
            is_active: rerankActive,
            target: rerankTarget || null,
            include_summary: rerankSummary,
          };
        }

        const filters = Array.from(filtersContainer.children)
          .map((row) => {
            const [keyInput, valuesInput] = row.querySelectorAll("input");
            const key = keyInput.value.trim();
            const values = valuesInput.value
              .split(",")
              .map((value) => value.trim())
              .filter(Boolean);
            if (!key || !values.length) return null;
            return { key, values };
          })
          .filter(Boolean);

        if (filters.length) payload.filters = filters;

        return payload;
      }

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? "#f78c6c" : "#9da4b1";
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        let payload;

        try {
          payload = buildPayload(formData);
        } catch (err) {
          setStatus(err.message, true);
          return;
        }

        requestPreview.textContent = JSON.stringify(payload, null, 2);
        const endpoint = formData.get("endpoint");
        setStatus("요청 중...");

        try {
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const text = await response.text();
          let parsed;
          try {
            parsed = JSON.parse(text);
            responseOutput.textContent = JSON.stringify(parsed, null, 2);
            renderResponseCards(parsed);
          } catch {
            responseOutput.textContent = text || "(빈 응답)";
            renderResponseCards(null, "JSON 응답이 아니어서 카드로 표시할 수 없습니다.");
          }

          if (!response.ok) {
            setStatus(`오류: ${response.status} ${response.statusText}`, true);
          } else {
            setStatus("완료");
          }
        } catch (error) {
          setStatus(`요청 실패: ${error.message}`, true);
          responseOutput.textContent = "네트워크 에러가 발생했습니다.";
          renderResponseCards(null, "네트워크 에러로 결과를 불러오지 못했습니다.");
        }
      });

      function renderResponseCards(apiResponse, emptyMessage) {
        if (!responseCards) return;
        responseCards.innerHTML = "";

        const results = apiResponse?.results;
        if (!Array.isArray(results) || !results.length) {
          const message = document.createElement("p");
          message.className = "muted";
          message.textContent =
            emptyMessage ||
            (apiResponse
              ? "표시할 검색 결과가 없습니다."
              : "API 호출 후 검색 결과 카드가 여기에 표시됩니다.");
          responseCards.appendChild(message);
          return;
        }

        results.forEach((result, idx) => {
          const group = document.createElement("section");
          group.className = "result-group";

          const header = document.createElement("div");
          header.className = "result-group__header";
          const queryLabel = document.createElement("span");
          queryLabel.className = "query-label";
          queryLabel.textContent = `Query ${idx + 1}`;
          const queryText = document.createElement("div");
          queryText.className = "query-text";
          queryText.textContent = result?.query || "(질의 없음)";
          header.append(queryLabel, queryText);
          group.appendChild(header);

          const documents = Array.isArray(result?.retrieved_documents)
            ? result.retrieved_documents.filter(Boolean)
            : [];

          if (!documents.length) {
            const empty = document.createElement("p");
            empty.className = "muted";
            empty.textContent = "검색 결과가 없습니다.";
            group.appendChild(empty);
          } else {
            documents.forEach((doc, docIdx) => {
              group.appendChild(createDocumentCard(doc, docIdx + 1));
            });
          }

          responseCards.appendChild(group);
        });
      }

      function createDocumentCard(doc, order) {
        const payload = doc?.payload || {};
        const card = document.createElement("article");
        card.className = "doc-card";

        const header = document.createElement("header");
        header.className = "doc-card__header";
        const title = document.createElement("div");
        title.className = "doc-card__title";
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = `#${order}`;
        const idEl = document.createElement("span");
        idEl.className = "doc-card__id";
        idEl.textContent = doc?.id || "(id 없음)";
        title.append(badge, idEl);

        const scoreEl = document.createElement("span");
        scoreEl.className = "doc-card__score";
        scoreEl.textContent = `score ${formatScore(doc?.score)}`;
        header.append(title, scoreEl);
        card.appendChild(header);

        const metaList = document.createElement("dl");
        metaList.className = "meta-list";
        appendMeta(metaList, "파일", createFileLink(payload.file));
        appendMeta(metaList, "페이지", payload.page_num ?? "-");
        appendMeta(metaList, "서비스", createServiceChips(payload));
        appendMeta(metaList, "NER", formatBoolean(payload.ner));
        appendMeta(metaList, "요약", payload.summary || "(요약 없음)");
        appendMeta(
          metaList,
          "child_chunk_length",
          valueOrDash(payload.child_chunk_length)
        );
        appendMeta(
          metaList,
          "parent_chunk_length",
          valueOrDash(payload.parent_chunk_length)
        );
        card.appendChild(metaList);

        card.appendChild(createTextPanel("Parent Text", payload.parent_text));
        card.appendChild(createTextPanel("Text", payload.text));

        return card;
      }

      function appendMeta(list, label, value) {
        const dt = document.createElement("dt");
        dt.textContent = label;
        const dd = document.createElement("dd");
        if (value instanceof Node) {
          dd.appendChild(value);
        } else {
          dd.textContent = value ?? "-";
        }
        list.append(dt, dd);
      }

      function createFileLink(filePath) {
        if (!filePath) return document.createTextNode("-");
        const link = document.createElement("a");
        link.href = filePath;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.className = "file-link";
        link.textContent = filePath.split("/").pop() || filePath;
        return link;
      }

      function createServiceChips(payload) {
        const services =
          normalizeList(payload?.services) ||
          normalizeList(payload?.service) ||
          [];
        if (!services.length) return document.createTextNode("-");
        const wrapper = document.createElement("div");
        wrapper.className = "service-chips";
        services.forEach((service) => {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = service;
          wrapper.appendChild(chip);
        });
        return wrapper;
      }

      function normalizeList(value) {
        if (!value) return null;
        if (Array.isArray(value)) {
          return value.map((item) => `${item}`.trim()).filter(Boolean);
        }
        if (typeof value === "string") {
          return value
            .split(",")
            .map((item) => item.trim())
            .filter(Boolean);
        }
        return null;
      }

      function formatBoolean(value) {
        if (value === null || value === undefined) return "-";
        return value ? "true" : "false";
      }

      function valueOrDash(value) {
        return value === null || value === undefined ? "-" : value;
      }

      function formatScore(score) {
        if (typeof score === "number") {
          return score.toFixed(4);
        }
        return score ?? "-";
      }

      function createTextPanel(title, content) {
        const section = document.createElement("section");
        section.className = "text-panel";

        const header = document.createElement("div");
        header.className = "text-panel__header";
        const heading = document.createElement("h4");
        heading.textContent = title;

        const controls = document.createElement("div");
        controls.className = "text-panel__controls";

        const htmlBtn = createToggleButton("HTML 보기", true);
        const rawBtn = createToggleButton("원본 보기");
        const copyBtn = createToggleButton("클립보드 복사");

        controls.append(htmlBtn, rawBtn, copyBtn);
        header.append(heading, controls);

        const body = document.createElement("div");
        body.className = "text-panel__body";

        const htmlView = document.createElement("div");
        htmlView.className = "text-panel__content";
        htmlView.innerHTML = content || "<em>내용이 없습니다.</em>";

        const rawView = document.createElement("pre");
        rawView.className = "text-panel__content is-hidden";
        rawView.textContent = content || "";

        body.append(htmlView, rawView);

        htmlBtn.addEventListener("click", () => {
          htmlBtn.classList.add("active");
          rawBtn.classList.remove("active");
          htmlView.classList.remove("is-hidden");
          rawView.classList.add("is-hidden");
        });

        rawBtn.addEventListener("click", () => {
          rawBtn.classList.add("active");
          htmlBtn.classList.remove("active");
          rawView.classList.remove("is-hidden");
          htmlView.classList.add("is-hidden");
        });

        copyBtn.addEventListener("click", async () => {
          copyBtn.disabled = true;
          const original = copyBtn.textContent;
          try {
            await copyToClipboard(content || "");
            copyBtn.textContent = "복사 완료";
          } catch (error) {
            console.error("clipboard error", error);
            copyBtn.textContent = "복사 실패";
          }
          setTimeout(() => {
            copyBtn.disabled = false;
            copyBtn.textContent = original;
          }, 1200);
        });

        section.append(header, body);
        return section;
      }

      function createToggleButton(label, isActive = false) {
        const button = document.createElement("button");
        button.type = "button";
        button.className = `pill-button small${isActive ? " active" : ""}`;
        button.textContent = label;
        return button;
      }

      async function copyToClipboard(text) {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
          return;
        }
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }

      renderResponseCards();
    </script>
  </body>
</html>
