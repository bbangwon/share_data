<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qdrant Points Tuning</title>
    <style>
      :root {
        color-scheme: light;
        --accent: #0f766e;
        --accent-strong: #115e59;
        --bg: #f8fafc;
        --panel: #ffffff;
        --border: #d9e2ec;
        --text: #0f172a;
        --muted: #475569;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", sans-serif;
        background: radial-gradient(
            circle at 20% 20%,
            #eef2ff 0,
            #eef2ff 25%,
            transparent 25%
          ),
          var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding: 32px 12px 48px;
      }
      .page {
        max-width: 1100px;
        margin: 0 auto;
        display: grid;
        gap: 18px;
      }
      h1 {
        margin: 0 0 4px;
        font-size: 28px;
        letter-spacing: -0.02em;
      }
      p.lead {
        margin: 0 0 12px;
        color: var(--muted);
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 18px;
        box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
      }
      .card h2 {
        margin: 0 0 10px;
        font-size: 19px;
      }
      form {
        display: grid;
        gap: 12px;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-weight: 600;
        color: var(--muted);
        font-size: 14px;
      }
      input,
      textarea,
      button {
        font: inherit;
      }
      input[type="text"],
      input[type="number"],
      textarea {
        padding: 9px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #f8fafc;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.15);
        background: #fff;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      .row {
        display: grid;
        gap: 10px;
      }
      @media (min-width: 720px) {
        .row.two {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .row.three {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 9px;
        padding: 12px 16px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease,
          background 0.15s ease;
      }
      button:hover {
        background: var(--accent-strong);
        box-shadow: 0 6px 18px rgba(15, 118, 110, 0.22);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        background: #cbd5e1;
      }
      .status {
        font-size: 14px;
        color: var(--muted);
      }
      .status strong {
        color: var(--accent-strong);
      }
      .points {
        display: grid;
        gap: 10px;
        margin-top: 8px;
      }
      .point {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        display: grid;
        gap: 6px;
        background: #f9fbff;
      }
      .point header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: var(--muted);
      }
      .pill {
        padding: 4px 8px;
        border-radius: 999px;
        background: #e2f3f0;
        color: var(--accent-strong);
        font-weight: 700;
        font-size: 12px;
      }
      .payload {
        font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco,
          Consolas, "Liberation Mono", "Courier New", monospace;
        background: #0f172a;
        color: #e2e8f0;
        padding: 8px 10px;
        border-radius: 8px;
        overflow: auto;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
      }
      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .error {
        color: #b91c1c;
        font-weight: 700;
      }
      .success {
        color: #0f766e;
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>Qdrant Points Tuning</h1>
        <p class="lead">
          파일명과 페이지로 포인트를 조회하고, 선택한 포인트에 boost keywords를
          적용합니다.
        </p>
      </header>

      <section class="card">
        <h2>검색 설정</h2>
        <form id="searchForm">
          <div class="row two">
            <label>
              API Base URL
              <input id="apiBase" type="text" required />
            </label>
            <label>
              Collection Name
              <input
                id="collectionName"
                type="text"
                placeholder="ex) your_collection"
                required
              />
            </label>
          </div>
          <div class="row three">
            <label>
              File Name
              <input
                id="fileName"
                type="text"
                placeholder="파일명을 입력하세요"
                required
              />
            </label>
            <label>
              Page Number (optional)
              <input id="pageNum" type="number" min="1" placeholder="예: 3" />
            </label>
            <label>
              Fetch All Points
              <select id="fetchAll">
                <option value="true" selected>전체 조회</option>
                <option value="false">부분 조회 (offset/limit)</option>
              </select>
            </label>
          </div>
          <div class="row two" id="partialControls" style="display: none">
            <label>
              Offset (point id)
              <input
                id="offset"
                type="text"
                placeholder="부분 조회 시작 point_id"
              />
            </label>
            <label>
              Limit
              <input id="offsetLimit" type="number" min="1" value="20" />
            </label>
          </div>
          <button type="submit">포인트 검색</button>
          <div id="searchStatus" class="status"></div>
        </form>
      </section>

      <section class="card">
        <div class="actions" style="justify-content: space-between">
          <h2 style="margin: 0">검색 결과</h2>
          <div class="muted" id="selectionHint">선택된 포인트: 0</div>
        </div>
        <div class="actions" style="margin-top: 8px">
          <button type="button" id="selectAllBtn">전체 선택</button>
          <button type="button" id="clearSelectionBtn">선택 해제</button>
        </div>
        <div id="pointsContainer" class="points"></div>
      </section>

      <section class="card">
        <h2>Process Points Tunning</h2>
        <form id="tuneForm">
          <label>
            Boost Keywords
            <textarea
              id="boostKeywords"
              placeholder="예: 부산시 스마트팩토리 지원"
            ></textarea>
          </label>
          <button type="submit" id="tuneBtn" disabled>
            선택 포인트 업데이트
          </button>
          <div id="tuneStatus" class="status"></div>
        </form>
      </section>
    </div>

    <script>
      const apiBaseInput = document.getElementById("apiBase");
      const collectionInput = document.getElementById("collectionName");
      const fileInput = document.getElementById("fileName");
      const pageInput = document.getElementById("pageNum");
      const fetchAllSelect = document.getElementById("fetchAll");
      const offsetInput = document.getElementById("offset");
      const offsetLimitInput = document.getElementById("offsetLimit");
      const partialControls = document.getElementById("partialControls");
      const searchForm = document.getElementById("searchForm");
      const searchStatus = document.getElementById("searchStatus");
      const pointsContainer = document.getElementById("pointsContainer");
      const selectAllBtn = document.getElementById("selectAllBtn");
      const clearSelectionBtn = document.getElementById("clearSelectionBtn");
      const selectionHint = document.getElementById("selectionHint");
      const tuneForm = document.getElementById("tuneForm");
      const boostKeywordsInput = document.getElementById("boostKeywords");
      const tuneStatus = document.getElementById("tuneStatus");
      const tuneBtn = document.getElementById("tuneBtn");

      const defaultApiBase = new URL(
        "/api/v1/qdrant",
        window.location.origin
      ).href.replace(/\$/, "");
      apiBaseInput.value = defaultApiBase;

      const state = {
        points: [],
        selected: new Set(),
      };

      fetchAllSelect.addEventListener("change", () => {
        const isAll = fetchAllSelect.value === "true";
        partialControls.style.display = isAll ? "none" : "grid";
      });

      selectAllBtn.addEventListener("click", () => {
        state.points.forEach((p) => state.selected.add(p.id));
        syncSelectionUI();
      });

      clearSelectionBtn.addEventListener("click", () => {
        state.selected.clear();
        syncSelectionUI();
      });

      searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        searchStatus.textContent = "";
        tuneStatus.textContent = "";
        pointsContainer.innerHTML = "";
        state.points = [];
        state.selected.clear();
        syncSelectionUI();

        const base = apiBaseInput.value.trim().replace(/\$/, "");
        const collection = collectionInput.value.trim();
        const fileName = fileInput.value.trim();
        const page = pageInput.value ? Number(pageInput.value) : null;
        const fetchAll = fetchAllSelect.value === "true";
        const offset = offsetInput.value.trim() || null;
        const offsetLimit = offsetLimitInput.value
          ? Number(offsetLimitInput.value)
          : 20;

        if (!base || !collection || !fileName) {
          searchStatus.innerHTML =
            '<span class="error">API Base, Collection, File Name은 필수입니다.</span>';
          return;
        }

        const payload = {
          file_name: fileName,
          fetch_all: fetchAll,
          page_num: page || null,
          offset_limit: offsetLimit || 20,
          offset: offset || null,
        };

        searchStatus.textContent = "포인트를 불러오는 중...";

        try {
          const res = await fetch(
            `${base}/collections/${encodeURIComponent(collection)}/points`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || `요청 실패 (status: ${res.status})`);
          }
          const data = await res.json();
          const points = data.points || [];
          state.points = points;
          renderPoints(points);
          searchStatus.innerHTML = `<strong>${points.length}</strong>개의 포인트를 불러왔습니다.`;
        } catch (err) {
          console.error(err);
          searchStatus.innerHTML =
            '<span class="error">검색 실패: ' + err.message + "</span>";
        } finally {
          syncSelectionUI();
        }
      });

      tuneForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        tuneStatus.textContent = "";

        const base = apiBaseInput.value.trim().replace(/\$/, "");
        const collection = collectionInput.value.trim();
        const boostKeywords = boostKeywordsInput.value.trim();
        const pointIds = Array.from(state.selected);

        if (!base || !collection) {
          tuneStatus.innerHTML =
            '<span class="error">API Base와 Collection을 입력하세요.</span>';
          return;
        }
        if (pointIds.length === 0) {
          tuneStatus.innerHTML =
            '<span class="error">업데이트할 포인트를 선택하세요.</span>';
          return;
        }
        if (!boostKeywords) {
          tuneStatus.innerHTML =
            '<span class="error">Boost keywords를 입력하세요.</span>';
          return;
        }

        const payload = {
          point_ids: pointIds,
          boost_keywords: boostKeywords,
        };

        tuneBtn.disabled = true;
        tuneStatus.textContent = "업데이트 중...";

        try {
          const res = await fetch(
            `${base}/collections/${encodeURIComponent(collection)}/points`,
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || `요청 실패 (status: ${res.status})`);
          }
          const data = await res.json();
          tuneStatus.innerHTML =
            '<span class="success">완료:</span> ' + JSON.stringify(data);
        } catch (err) {
          console.error(err);
          tuneStatus.innerHTML =
            '<span class="error">업데이트 실패: ' + err.message + "</span>";
        } finally {
          tuneBtn.disabled = false;
        }
      });

      function renderPoints(points) {
        pointsContainer.innerHTML = "";
        if (!points.length) {
          pointsContainer.innerHTML =
            '<div class="muted">검색 결과가 없습니다.</div>';
          return;
        }
        points.forEach((p, idx) => {
          const div = document.createElement("div");
          div.className = "point";
          const payloadText = JSON.stringify(p.payload || {}, null, 2);
          div.innerHTML = `
            <header>
              <div class="actions">
                <input type="checkbox" data-point-id="${
                  p.id
                }" aria-label="select point ${p.id}" />
                <span class="pill">#${idx + 1}</span>
                <span class="muted">ID: ${p.id}</span>
              </div>
              <div class="muted">score: ${p.score ?? "n/a"}</div>
            </header>
            <div class="payload">${payloadText}</div>
          `;
          const checkbox = div.querySelector("input[type='checkbox']");
          checkbox.checked = state.selected.has(p.id);
          checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
              state.selected.add(p.id);
            } else {
              state.selected.delete(p.id);
            }
            syncSelectionUI();
          });
          pointsContainer.appendChild(div);
        });
      }

      function syncSelectionUI() {
        selectionHint.textContent = `선택된 포인트: ${state.selected.size}`;
        tuneBtn.disabled = state.selected.size === 0;
        document.querySelectorAll("[data-point-id]").forEach((box) => {
          const id = box.getAttribute("data-point-id");
          box.checked = state.selected.has(id);
        });
      }
    </script>
  </body>
</html>
