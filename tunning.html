<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qdrant Points Tuning</title>
    <style>
      :root {
        color-scheme: light;
        --accent: #0f766e;
        --accent-strong: #115e59;
        --bg: #f8fafc;
        --panel: #ffffff;
        --border: #d9e2ec;
        --text: #0f172a;
        --muted: #475569;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
        background: radial-gradient(circle at 20% 20%, #eef2ff 0, #eef2ff 25%, transparent 25%),
          var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding: 32px 12px 48px;
      }
      .page {
        max-width: 1100px;
        margin: 0 auto;
        display: grid;
        gap: 18px;
      }
      h1 {
        margin: 0 0 4px;
        font-size: 28px;
        letter-spacing: -0.02em;
      }
      p.lead {
        margin: 0 0 12px;
        color: var(--muted);
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 18px;
        box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
      }
      .card h2 {
        margin: 0 0 10px;
        font-size: 19px;
      }
      form {
        display: grid;
        gap: 12px;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-weight: 600;
        color: var(--muted);
        font-size: 14px;
      }
      input,
      textarea,
      button {
        font: inherit;
      }
      input[type="text"],
      input[type="number"],
      textarea {
        padding: 9px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #f8fafc;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }
      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.15);
        background: #fff;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      .row {
        display: grid;
        gap: 10px;
      }
      .row.required {
        grid-template-columns: 1fr;
      }
      .row.optional {
        grid-template-columns: 1fr;
      }
      @media (min-width: 720px) {
        .row.two {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .row.three {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        .row.required {
          grid-template-columns: 2fr 1fr;
        }
        .row.optional {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 9px;
        padding: 12px 16px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      }
      button:hover {
        background: var(--accent-strong);
        box-shadow: 0 6px 18px rgba(15, 118, 110, 0.22);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        background: #cbd5e1;
      }
      .status {
        font-size: 14px;
        color: var(--muted);
      }
      .status strong {
        color: var(--accent-strong);
      }
      .points {
        display: grid;
        gap: 10px;
        margin-top: 8px;
      }
      .point {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        display: grid;
        gap: 6px;
        background: #f9fbff;
      }
      .point header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: var(--muted);
      }
      .pill {
        padding: 4px 8px;
        border-radius: 999px;
        background: #e2f3f0;
        color: var(--accent-strong);
        font-weight: 700;
        font-size: 12px;
      }
      .payload {
        font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        background: #0f172a;
        color: #e2e8f0;
        padding: 8px 10px;
        border-radius: 8px;
        overflow: auto;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
      }
      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .error {
        color: #b91c1c;
        font-weight: 700;
      }
      .success {
        color: #0f766e;
        font-weight: 700;
      }
      .meta-grid {
        display: flex;
        flex-direction: column;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
      }
      .meta-item {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        background: #fff;
      }
      .meta-item .meta-label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }
      .meta-item .meta-value {
        font-weight: 700;
        color: var(--text);
        word-break: break-word;
      }
      .text-block {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        background: #fff;
        display: grid;
        gap: 8px;
      }
      .text-block__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }
      .text-block__title {
        font-weight: 700;
        color: var(--text);
      }
      .view-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .view-btn {
        border: 1px solid var(--border);
        background: #f8fafc;
        color: var(--text);
        padding: 6px 10px;
        border-radius: 7px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.15s ease;
      }
      .view-btn:hover {
        border-color: var(--accent);
        color: var(--accent-strong);
      }
      .view-btn.is-active {
        background: #e2f3f0;
        border-color: var(--accent);
        color: var(--accent-strong);
      }
      .text-block__body {
        border: 1px dashed var(--border);
        border-radius: 8px;
        padding: 10px;
        background: #f8fafc;
        min-height: 60px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .payload-details {
        border: 1px dashed var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        background: #fff;
      }
      .payload-details summary {
        cursor: pointer;
        font-weight: 700;
        color: var(--accent-strong);
      }
      .payload-details[open] summary {
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>Qdrant Points Tuning</h1>
        <p class="lead">
          파일명과 페이지로 포인트를 조회하고, 선택한 포인트에 boost keywords를 적용합니다.
        </p>
      </header>

      <section class="card">
        <h2>검색 설정</h2>
        <form id="searchForm">
          <div class="row two">
            <label>
              ❗API Base URL
              <input
                id="apiBase"
                type="text"
                value="http://99.1.82.169:8080/api/v1/qdrant"
                required
              />
            </label>
            <label>
              ❗Collection Name
              <input
                id="collectionName"
                type="text"
                placeholder="ex) your_collection"
                value="BusanCity"
                required
              />
            </label>
          </div>
          <div class="row required">
            <label>
              ❗File Name
              <input
                id="fileName"
                type="text"
                placeholder="파일명을 정확하게 입력해주세요"
                required
              />
            </label>
            <label>
              ❗Limit
              <input id="limit" type="number" min="0" value="10" required />
              <span class="muted" style="color: gray; font-style: oblique; text-align: right"
                >* 0 입력 시 검색 조건에 맞는 모든 포인트 조회</span
              >
            </label>
          </div>
          <div class="row optional">
            <label>
              Page Number (optional)
              <input id="pageNum" type="number" min="1" placeholder="예: 3" />
            </label>
            <label>
              Parent Index (optional)
              <input id="parentIdx" type="number" min="0" placeholder="예: 1" />
            </label>
            <label>
              Offset (optional)
              <input id="offset" type="text" placeholder="부분 조회 시작 point_id" />
            </label>
          </div>
          <button type="submit">포인트 검색</button>
          <div id="searchStatus" class="status"></div>
        </form>
      </section>

      <section class="card">
        <div class="actions" style="justify-content: space-between">
          <h2 style="margin: 0">검색 결과</h2>
          <div class="muted" id="selectionHint">선택된 포인트: 0</div>
        </div>
        <div class="actions" style="margin-top: 8px">
          <button type="button" id="selectAllBtn">전체 선택</button>
          <button type="button" id="clearSelectionBtn">선택 해제</button>
        </div>
        <div id="pointsContainer" class="points"></div>
      </section>

      <section class="card">
        <h2>Process Points Tunning</h2>
        <form id="tuneForm">
          <label>
            Boost Keywords
            <textarea id="boostKeywords" placeholder="예: 부산시 스마트팩토리 지원"></textarea>
          </label>
          <button type="submit" id="tuneBtn" disabled>선택 포인트 업데이트</button>
          <div id="tuneStatus" class="status"></div>
        </form>
      </section>
    </div>

    <script>
      const FILE_DOWNLOAD_BASE_URL = "https://busanai.busan.go.kr/download/";
      const apiBaseInput = document.getElementById("apiBase");
      const collectionInput = document.getElementById("collectionName");
      const fileInput = document.getElementById("fileName");
      const pageInput = document.getElementById("pageNum");
      const parentIdxInput = document.getElementById("parentIdx");
      const offsetInput = document.getElementById("offset");
      const limitInput = document.getElementById("limit");
      const searchForm = document.getElementById("searchForm");
      const searchStatus = document.getElementById("searchStatus");
      const pointsContainer = document.getElementById("pointsContainer");
      const selectAllBtn = document.getElementById("selectAllBtn");
      const clearSelectionBtn = document.getElementById("clearSelectionBtn");
      const selectionHint = document.getElementById("selectionHint");
      const tuneForm = document.getElementById("tuneForm");
      const boostKeywordsInput = document.getElementById("boostKeywords");
      const tuneStatus = document.getElementById("tuneStatus");
      const tuneBtn = document.getElementById("tuneBtn");

      const state = {
        points: [],
        selected: new Set(),
      };

      selectAllBtn.addEventListener("click", () => {
        state.points.forEach((p) => state.selected.add(p.id));
        syncSelectionUI();
      });

      clearSelectionBtn.addEventListener("click", () => {
        state.selected.clear();
        syncSelectionUI();
      });

      searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        searchStatus.textContent = "";
        tuneStatus.textContent = "";
        pointsContainer.innerHTML = "";
        state.points = [];
        state.selected.clear();
        syncSelectionUI();

        const base = apiBaseInput.value.trim().replace(/\$/, "");
        const collection = collectionInput.value.trim();
        const fileName = fileInput.value.trim();
        const page = pageInput.value ? Number(pageInput.value) : null;
        const parentIdx = parentIdxInput.value ? Number(parentIdxInput.value) : null;
        const offset = offsetInput.value.trim() || null;
        const limitValue = limitInput.value.trim();
        const limit = limitValue === "" ? null : Number(limitValue);

        if (!base || !collection || !fileName) {
          searchStatus.innerHTML =
            '<span class="error">API Base, Collection, File Name은 필수입니다.</span>';
          return;
        }
        if (limit === null || Number.isNaN(limit) || limit < 0) {
          searchStatus.innerHTML = '<span class="error">Limit은 0 이상의 숫자여야 합니다.</span>';
          return;
        }

        const payload = {
          file_name: fileName,
          limit,
          page_num: page || null,
          parent_idx: parentIdx ?? null,
          offset: offset || null,
        };

        searchStatus.textContent = "포인트를 불러오는 중...";

        try {
          const res = await fetch(`${base}/collections/${encodeURIComponent(collection)}/points`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || `요청 실패 (status: ${res.status})`);
          }
          const data = await res.json();
          const points = data.points || [];
          points.sort((a, b) => a.payload.page_num - b.payload.page_num);
          state.points = points;
          renderPoints(points);
          searchStatus.innerHTML = `<strong>${points.length}</strong>개의 포인트를 불러왔습니다.`;
        } catch (err) {
          console.error(err);
          searchStatus.innerHTML = '<span class="error">검색 실패: ' + err.message + "</span>";
        } finally {
          syncSelectionUI();
        }
      });

      tuneForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        tuneStatus.textContent = "";

        const base = apiBaseInput.value.trim().replace(/\$/, "");
        const collection = collectionInput.value.trim();
        const boostKeywords = boostKeywordsInput.value.trim();
        const pointIds = Array.from(state.selected);

        if (!base || !collection) {
          tuneStatus.innerHTML = '<span class="error">API Base와 Collection을 입력하세요.</span>';
          return;
        }
        if (pointIds.length === 0) {
          tuneStatus.innerHTML = '<span class="error">업데이트할 포인트를 선택하세요.</span>';
          return;
        }
        if (!boostKeywords) {
          tuneStatus.innerHTML = '<span class="error">Boost keywords를 입력하세요.</span>';
          return;
        }

        const payload = {
          point_ids: pointIds,
          boost_keywords: boostKeywords,
        };

        tuneBtn.disabled = true;
        tuneStatus.textContent = "업데이트 중...";

        try {
          const res = await fetch(`${base}/collections/${encodeURIComponent(collection)}/points`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || `요청 실패 (status: ${res.status})`);
          }
          const data = await res.json();
          tuneStatus.innerHTML = '<span class="success">완료:</span> ' + JSON.stringify(data);
        } catch (err) {
          console.error(err);
          tuneStatus.innerHTML = '<span class="error">업데이트 실패: ' + err.message + "</span>";
        } finally {
          tuneBtn.disabled = false;
        }
      });

      function escapeHTML(str) {
        if (typeof str !== "string") str = String(str ?? "");
        return (str || "").replace(
          /[&<>"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch] || ch)
        );
      }

      function formatBoostKeywords(value) {
        if (Array.isArray(value)) {
          return value.length ? value.join(", ") : "-";
        }
        return value || "-";
      }

      function setTextBody(el, mode) {
        const raw = el.dataset.raw || "";
        el.dataset.mode = mode;
        if (mode === "html") {
          el.innerHTML = raw || '<span class="muted">내용 없음</span>';
        } else {
          el.textContent = raw || "내용 없음";
        }
      }

      function setActiveButtons(container, targetId, mode) {
        container.querySelectorAll(`[data-target="${targetId}"][data-mode]`).forEach((btn) => {
          btn.classList.toggle("is-active", btn.dataset.mode === mode);
        });
      }

      async function copyText(text) {
        try {
          await navigator.clipboard.writeText(text || "");
        } catch (err) {
          console.error("Copy failed", err);
          const textarea = document.createElement("textarea");
          textarea.value = text || "";
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
        }
      }

      function createFileLink(filePath, pageNum) {
        if (!filePath) return document.createTextNode("-");

        const parts = filePath.split("/");
        const filtered = parts.filter(Boolean);
        const rest = filtered.slice(2);
        filePath = rest.join("/");

        const encodedPath = encodeURIComponent(filePath);
        const link = document.createElement("a");
        const filename = filePath.split("/").pop() || filePath;

        link.href = `${FILE_DOWNLOAD_BASE_URL}${encodedPath}#page=${pageNum}`;
        link.target = "_blank";
        link.rel = "noopener noreferrer";
        link.textContent = filename;
        link.title = filename;
        return link.outerHTML;
      }

      function renderPoints(points) {
        pointsContainer.innerHTML = "";
        if (!points.length) {
          pointsContainer.innerHTML = '<div class="muted">검색 결과가 없습니다.</div>';
          return;
        }
        points.forEach((p, idx) => {
          const payload = p.payload || {};
          const div = document.createElement("div");
          div.className = "point";
          const payloadText = JSON.stringify(payload, null, 2);
          const parentText = payload.parent_text || "";
          const chunkText = payload.text || "";
          const service = payload.service || "-";
          const group = payload.group || "-";
          const boostKeywords = formatBoostKeywords(payload.boost_keywords);
          const filePath = payload.file_path || "-";
          const pageNum =
            payload.page_num === 0 || payload.page_num ? String(payload.page_num) : "-";

          const parentId = `parent-${p.id}-${idx}`;
          const textId = `text-${p.id}-${idx}`;
          div.innerHTML = `
            <header>
              <div class="actions">
                <input type="checkbox" data-point-id="${p.id}" aria-label="select point ${p.id}" />
                <span class="pill">#${idx + 1}</span>
                <span class="muted">ID: ${p.id}</span>
              </div>              
            </header>
            <div class="meta-grid">

              <div class="meta-item">
                <div class="meta-label">File Path</div>
                <div class="meta-value">${createFileLink(filePath, pageNum)}</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Page Num</div>
                <div class="meta-value">${escapeHTML(pageNum)}</div>
              </div>
            </div>
            <div class="text-block">
              <div class="text-block__header">
                <div class="text-block__title">Parent Text</div>
                <div class="view-buttons">
                  <button type="button" class="view-btn" data-target="${parentId}" data-mode="html">HTML 보기</button>
                  <button type="button" class="view-btn" data-target="${parentId}" data-mode="raw">원본 보기</button>
                  <button type="button" class="view-btn" data-target="${parentId}" data-action="copy">복사하기</button>
                </div>
              </div>
              <div class="text-block__body" data-content="${parentId}"></div>
            </div>
            <div class="text-block">
              <div class="text-block__header">
                <div class="text-block__title">Text</div>
                <div class="view-buttons">
                  <button type="button" class="view-btn" data-target="${textId}" data-mode="html">HTML 보기</button>
                  <button type="button" class="view-btn" data-target="${textId}" data-mode="raw">원본 보기</button>
                  <button type="button" class="view-btn" data-target="${textId}" data-action="copy">복사하기</button>
                </div>
              </div>
              <div class="text-block__body" data-content="${textId}"></div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Service</div>
              <div class="meta-value">${escapeHTML(service)}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Group</div>
              <div class="meta-value">${escapeHTML(group)}</div>
            </div>            
            <div class="meta-item">
              <div class="meta-label">Boost Keywords</div>
              <div class="meta-value">${escapeHTML(boostKeywords)}</div>
            </div>
            <details class="payload-details">
              <summary>원본 payload 보기</summary>
              <pre class="payload"></pre>
            </details>
          `;
          const checkbox = div.querySelector("input[type='checkbox']");
          checkbox.checked = state.selected.has(p.id);
          checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
              state.selected.add(p.id);
            } else {
              state.selected.delete(p.id);
            }
            syncSelectionUI();
          });
          const parentBody = div.querySelector(`[data-content="${parentId}"]`);
          const textBody = div.querySelector(`[data-content="${textId}"]`);
          parentBody.dataset.raw = parentText;
          textBody.dataset.raw = chunkText;
          setTextBody(parentBody, "html");
          setTextBody(textBody, "html");
          setActiveButtons(div, parentId, "html");
          setActiveButtons(div, textId, "html");

          div.querySelectorAll(`[data-target="${parentId}"]`).forEach((btn) => {
            btn.addEventListener("click", () => {
              const action = btn.dataset.action;
              if (action === "copy") {
                copyText(parentBody.dataset.raw || "");
                return;
              }
              const mode = btn.dataset.mode || "raw";
              setTextBody(parentBody, mode);
              setActiveButtons(div, parentId, mode);
            });
          });

          div.querySelectorAll(`[data-target="${textId}"]`).forEach((btn) => {
            btn.addEventListener("click", () => {
              const action = btn.dataset.action;
              if (action === "copy") {
                copyText(textBody.dataset.raw || "");
                return;
              }
              const mode = btn.dataset.mode || "raw";
              setTextBody(textBody, mode);
              setActiveButtons(div, textId, mode);
            });
          });

          const payloadPre = div.querySelector("pre.payload");
          payloadPre.textContent = payloadText;
          pointsContainer.appendChild(div);
        });
      }

      function syncSelectionUI() {
        selectionHint.textContent = `선택된 포인트: ${state.selected.size}`;
        tuneBtn.disabled = state.selected.size === 0;
        document.querySelectorAll("[data-point-id]").forEach((box) => {
          const id = box.getAttribute("data-point-id");
          box.checked = state.selected.has(id);
        });
      }
    </script>
  </body>
</html>
